 \documentclass[book.tex]{subfiles}
\begin{document}

The original Commander Keen, Commander Keen in Invasion of the Vorticons, was only released for the EGA videocard. Keen Dreams and later versions included a CGA version as well. The game play was exactly the same, sounds were the same, it was just that the graphics were CGA. Before diving into  the source code, let's first get a better understanding of the CGA video hardware.\\


\begin{figure}[H] 
  \centering 
  \scaledimage{1.0}{game/Keen_EGA_CGA.png} 
  \caption{Keen Dreams EGA and CGA version.}
\end{figure}

\par
\textbf{\underline{Trivia :}} It's an ironic twist that Softdisk did not use the original Keen's engine, as the code violated the company policy by depending on 16-color EGA hardware without supporting older 4-color CGA cards!\\
\par


 

\section{CGA Videocard}
The Color Graphics Adapter (CGA), originally also called the Color/Graphics Adapter or IBM Color/Graphics Monitor Adapter, introduced in 1981, was IBM's first color graphics card for the IBM XT.\\
\par
The CGA card can be summarized by the following hardware:
\begin{itemize}
  \item It was built around the Motorola 6845 display controller.
  \item The framebuffer (the VRAM) contained two memory banks of 8 kilobytes each, resulting in 16 kilobytes total.
  \item Character generator ROM, containing a 14-row font and two 8x8 fonts (same as used on the MDA videocard).
\end{itemize}

\begin{figure}[H] 
  \centering 
  \scaledimage{1.0}{hardware/IBM-CGA.jpg} 
  \caption{The CGA is a full-length 8-bit ISA card.}
\end{figure}

The CGA card has the following text and graphics modes:\\
\vspace{-10pt}
\begin{figure}[H]
\centering
\begin{table}[H]
\begin{tabularx}{\textwidth}[c]{llllcr}
\hline
\textbf{Mode} & \textbf{Type} & \textbf{Format} & \textbf{Colors} & \hspace{10pt}\textbf{RAM Mapping}\hspace{10pt} & \textbf{Hz}        \\ \hline
0             & text          & 40x25           & 16 (monochrome) & B8000h     & 60                           \\ \hline
1             & text          & 40x25           & 16              & B8000h    & 60                            \\ \hline
2             & text          & 80x25           & 16 (monochrome) & B8000h    & 60                            \\ \hline
3             & text          & 80x25           & 16              & B8000h    & 60                            \\ \hline
4             & CGA Graphics  & 320x200         & 4               & B8000h    & 60                            \\ \hline
5             & CGA Graphics  & 320x200         & 4 (monochrome)  & B8000h    & 60                            \\ \hline
6             & CGA Graphics  & 640x200         & 2               & B8000h    & 60                            \\ \hline

\end{tabularx}
\end{table}
\caption{EGA Modes available.}
\label{ega-modes-available}
 \end{figure} 

In the graphics mode 4, which is used by Commander Keen, each pixel is using 2 bits for color, resulting in only four colors being displayed at a time. These four colors could not be freely chosen from the 16 CGA colors, there were only two official palettes for this mode:
\begin{enumerate}
  \item Magenta, cyan, white and background colour (black by default).
  \item Red, green, brown/yellow and background colour (black by default).
\end{enumerate}
The background color could be any of the 16 colors, but often it was kept black. For each mode there is a high- and low-intensity version of the palette.\\

\begin{figure}[H]
\centering
\begin{table}[H]
\begin{tabularx}{\textwidth}[c]{|>{\hsize=.24\hsize}X |>{\hsize=.24\hsize}X |>{\hsize=.24\hsize}X |>{\hsize=.28\hsize}X |}
\hline
\multicolumn{2}{|c|}{\textbf{\color{black}Palette 1}} & \multicolumn{2}{|c|}{\textbf{\color{black}Palette 2}} 	\\ 
\hline
\textbf{\color{black} low intensity} & \textbf{\color{black} high intensity} & \textbf{\color{black} low intensity} & \textbf{\color{black} high intensity} \\
\color{white}\cellcolor{CGA_Black}0 - Background & \color{white}\cellcolor{CGA_Black} - Background &\color{white}\cellcolor{CGA_Black}0 - Background & \color{white}\cellcolor{CGA_Black}0 - Background \\

\color{black}\cellcolor{CGA_Green}2 - Green & \color{black}\cellcolor{CGA_Bright_Green}10 - Bright Green &\color{black}\cellcolor{CGA_Cyan}3 - Cyan & \color{black}\cellcolor{CGA_Bright_Cyan}11 - Bright Cyan \\

\color{black}\cellcolor{CGA_Red}4 - Red & \color{black}\cellcolor{CGA_Bright_Red}12 - Bright Red &\color{black}\cellcolor{CGA_Magenta}5 - Magenta & \color{black}\cellcolor{CGA_Bright_Magenta}13 - Bright Magenta \\

\color{black}\cellcolor{CGA_Brown}6 - Brown & \color{black}\cellcolor{CGA_Bright_Brown}14 - Yellow &\color{black}\cellcolor{CGA_Light_Grey}7 - Bright Grey & \color{black}\cellcolor{CGA_White}15 - White \\
\hline

\end{tabularx}
\end{table}
\caption{CGA color palettes.}
\label{default_ega_palette}
 \end{figure}
 
The default palette when switching to Mode 4 is palette 2 with high intensity, which is used by Commander Keen. Beside the limiation in number of colors, there are several other challenges to overcome:
\begin{itemize}
  \item The display memory was interlaced.
  \item The display memory was not sufficient to support double buffering. 
\end{itemize}
  


\subsection {Memory architecture and Interlacing}
The first complication of CGA is that the display memory in graphics modes was interlaced. Normally, video memory is strictly linear: the next row of display data corresponds to the next row of pixels. But with CGA, the next row of display data corresponded to the row of pixels two rows down. This continued until the end of the screen and only with the second half of display data were the in-between rows addressed. So the first half of display memory was for rows 0, 2, 4, etc., until the end of the screen and the second half of CGA RAM was for rows 1, 3, 5, etc. This added calculation steps to most CGA graphics operations if the programmer wanted to avoid visual artifacts when updating the screen.\\

\begin{figure}[H]
\centering
\includegraphics[width=1.0\textwidth]{imgs/drawings/cga_interlace.eps}
\caption{CGA interlaced memory.}
\label{fig:cga_interlaced}
\end{figure}

\par
Another complication of CGA is the size of VRAM. Each graphics modes requires all 16KiB of memory, so it is not possible to have double buffering in VRAM. \\


\subsection{Double buffering}



\section{TO BE INCLULDED}
The organization of the memory, 16K bytes by 8 bits, gave rise to one of the problems of CGA: In 80-column text mode, the adapter had to fetch 160 bytes per line- 80 characters and 80 attributes- leaving no time for the processor to read from or write to the display. Any program that went directly to the display memory quickly filled the screen with "snow." The read and write routines in the BIOS waited for horizontal retrace before accessing the memory. The scroll routine in the BIOS, which had to move lots of data, simply turned off the display, did the move, and then turned the display back on. There was a noticeable blink as the screen scrolled, but it was less objectionable than the blizzard that would have occurred otherwise.

\end{document}